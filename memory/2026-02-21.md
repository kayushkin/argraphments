# 2026-02-21 - Fixed Speaker Attribution Bug

## Issue
The conversation at https://kayushkin.com/argraphments/convo/soft-iris had incorrect tree/transcript connections. Speaker names in the argument tree didn't match the actual speakers from the transcript.

## Root Cause
1. **During persistence** (`persistStatements` in main.go): Was saving `s.Speaker` (display name like "Lane", "Pisco") to the `occurrences.speaker` column instead of `s.SpeakerID` (speaker identifier like "speaker_1", "speaker_2")
2. **During retrieval** (`claimTreeToStatements`): Wasn't populating the `speaker_id` field in API responses
3. **Frontend**: StatementNode.tsx already had code to resolve speakers from `msg_index`, but the data wasn't structured correctly for it to work

## Fix Applied
### Code Changes
1. **main.go `persistStatements`** (line 1109): Changed to save `s.SpeakerID` instead of `s.Speaker` to occurrences table (with fallback to `s.Speaker` for backward compatibility)
2. **main.go `claimTreeToStatements`**: Added population of `SpeakerID` field in API responses

### Data Migration
Created `cmd/migrate-speakers/main.go` to fix existing data:
- Iterates through all transcripts
- For each transcript, gets the speaker mapping (display name → speaker_id)
- Updates occurrences table to replace display names with speaker_ids
- Ran successfully on production, migrating 53 transcripts
- For soft-iris: Updated 41 occurrences (22 Lane→speaker_1, 19 Pisco→speaker_2)

## Verification
Confirmed the fix works:
- API now returns correct speaker_id values ("speaker_1", "speaker_2")  
- Frontend can now properly resolve speakers from msg_index via the messages array
- Speaker attribution in the argument tree now matches the transcript

## Commits
- fa2c48c: Fix speaker attribution in argument tree
- 10774c0: Add migration tool to fix speaker attribution in existing data
